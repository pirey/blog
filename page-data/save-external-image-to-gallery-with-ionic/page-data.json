{"componentChunkName":"component---src-templates-blog-post-js","path":"/save-external-image-to-gallery-with-ionic/","result":{"data":{"site":{"siteMetadata":{"title":"Yeri's Digital Note"}},"markdownRemark":{"id":"92ced428-f424-5771-8d49-8fe690e645f8","excerpt":"A few days ago I need to implement a feature where the user can save some displayed image in ionic app to the device image gallery. In my case, it was an image…","html":"<p>A few days ago I need to implement a feature where the user can save some displayed image in ionic app to the device image gallery. In my case, it was an image displayed using html img tag with external source url. So all I need was some method to download that file. Though the task is simple, it’s been a-lot-of-browsing activity since it was my first time dealing with cordova plugin. Then I decided to write this post, to explain the steps needed and wrap it all up. Let’s begin. First we create an ionic project, and move to that directory</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">ionic start saveimage blank\ncd saveimage</code></pre></div>\n<p>Then make sure we add appropriate platform <strong>Note:</strong> this tutorial is intended to work with android platform, since I have not successfully make it works on iOS.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\"># for android\nionic platform add android</code></pre></div>\n<p>In this project we will use ngCordova for easier use of cordova plugin within ionic. To set it up you can download the source files from <a href=\"http://ngcordova.com\">their website</a> or you can simply download it via bower:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">bower install ngCordova</code></pre></div>\n<p>If you don’t have bower installed just type the following command to install it.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">npm install -g bower</code></pre></div>\n<p>And then include it in <code class=\"language-text\">www/index.html</code>. If you installed it via bower, you can find the source file in <code class=\"language-text\">www/lib/</code> directory. Or include the appropriate file if you donwload the source files from the ngcordova website.</p>\n<div class=\"gatsby-highlight\" data-language=\"html\"><pre class=\"language-html\"><code class=\"language-html\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>script</span> <span class=\"token attr-name\">src</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>lib/ngCordova/dist/ng-cordova.js<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token script\"></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>script</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>script</span> <span class=\"token attr-name\">src</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>cordova.js<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token script\"></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>script</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<p>Next we need to include the ngCordova into our module. Open <code class=\"language-text\">www/js/app.js</code> and add the following</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">angular<span class=\"token punctuation\">.</span><span class=\"token function\">module</span><span class=\"token punctuation\">(</span><span class=\"token string\">'myApp'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'ngCordova'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>For the actual action to download the file, we need to install the <a href=\"http://ngcordova.com/docs/plugins/fileTransfer/\">cordova file transfer plugin</a>.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">ionic plugin add cordova-plugin-file-transfer</code></pre></div>\n<p>The file transfer plugin does not automatically add the downloaded file to the gallery, so we need additional plugin to do it. Install plugin to refresh gallery.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">ionic plugin add https://github.com/lotterfriends/refreshgallery</code></pre></div>\n<p>Note that without this plugin, we can still download the image file, but to make it available in the gallery, we have to reboot our device, and that’s kind of..inefficient. Ok, setup clear. Let’s make a test button to download the file. Don’t forget to associate the template with our controller. Put this in <code class=\"language-text\">www/index.html</code> </p>\n<div class=\"gatsby-highlight\" data-language=\"html\"><pre class=\"language-html\"><code class=\"language-html\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>ion-content</span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>padding<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">ng-controller</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>HomeCtrl<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>button</span> <span class=\"token attr-name\">ng-click</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>downloadImage()<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>button button-block button-positive<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n  Download\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>button</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>ion-content</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<p>Now create the controller, and make a scope function. Add the following code in the <code class=\"language-text\">www/js/app.js</code></p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token punctuation\">.</span><span class=\"token function\">controller</span><span class=\"token punctuation\">(</span><span class=\"token string\">'HomeCtrl'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">$scope<span class=\"token punctuation\">,</span> $cordovaFileTransfer</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  $scope<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">downloadImage</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">var</span> url <span class=\"token operator\">=</span> <span class=\"token string\">\"http://ngcordova.com/img/ngcordova-logo.png\"</span><span class=\"token punctuation\">,</span>\n        filename <span class=\"token operator\">=</span> url<span class=\"token punctuation\">.</span><span class=\"token function\">split</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">pop</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        targetPath <span class=\"token operator\">=</span> cordova<span class=\"token punctuation\">.</span>file<span class=\"token punctuation\">.</span>externalRootDirectory \\<span class=\"token operator\">+</span> filename<span class=\"token punctuation\">,</span>\n        options <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        trustHosts <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n\n    $cordovaFileTransfer<span class=\"token punctuation\">.</span><span class=\"token function\">download</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">,</span> targetPath<span class=\"token punctuation\">,</span> options<span class=\"token punctuation\">,</span> trustHosts<span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span>\n        <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">result</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token function\">alert</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Download success'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n          refreshMedia<span class=\"token punctuation\">.</span><span class=\"token function\">refresh</span><span class=\"token punctuation\">(</span>targetPath<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">err</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token function\">alert</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Error: '</span> <span class=\"token operator\">+</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">progress</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token comment\">// progressing download...</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>We add <code class=\"language-text\">$cordovaFileTransfer</code> as dependency to our controller. This is the service ngCordova provide to us. Then we call the <code class=\"language-text\">$cordovaFileTransfer.download()</code> method to download the file. The url parameter is the path to the file we want to download, and targetPath is the directory in the device to save our downloaded file.</p>\n<p>And..here is the part where I get lost I tried using <code class=\"language-text\">cordova.file.dataDirectory</code> but I can’t find the downloaded file anywhere on my device’s file browser let alone in the gallery, because apparently it points to private directory where the app is installed. Took me some times to realize it after exploring my android’s directories using <code class=\"language-text\">adb shell</code> command. Then, I finally found out that <code class=\"language-text\">cordova.file.externalRootDirectory</code> actually points to the root of <strong>internal storage</strong> of my android device! So I used it instead. Notice that the <code class=\"language-text\">cordova.file</code> is actually provided by <a href=\"http://ngcordova.com/docs/plugins/file/\">cordova file plugin</a>, however we can still access it with the file transfer plugin. You can get full list of provided paths <a href=\"https://github.com/apache/cordova-plugin-file#where-to-store-files\">here</a>.</p>\n<p>Note for iOS, I think you can use the <code class=\"language-text\">cordova.file.dataDirectory</code> path, but I haven’t tested it yet. Back to our download method. It returns a promise that we can pass some callback function on it. The first one is success callback, second is error callback, and the last is the callback that is called when the download is still progressing. And if you haven’t already noticed the <code class=\"language-text\">refreshMedia</code>, it is provided by ‘refresh gallery plugin’. The <code class=\"language-text\">refreshMedia.refresh()</code> method makes the file available in the gallery, immediately after downloaded.</p>\n<p><strong>Important:</strong> currently, we have to test the app on device and we can not test it in the browser via ‘ionic serve’… Well, you guess what? I think actually we can! But maybe that will be a discussion for another post.</p>\n<h2>Conclusion</h2>\n<p>Congratulations! We have learn how to download external image directly through ionic, moreover, we have also learn how to deal with cordova plugin. Well, thanks for reading! I hope you found something useful from here.</p>","frontmatter":{"title":"Save external image to gallery with ionic","date":"April 13, 2016","description":"Here you will learn to save external image to gallery in ionic"}}},"pageContext":{"slug":"/save-external-image-to-gallery-with-ionic/","previous":null,"next":{"fields":{"slug":"/ios-app-distribution-workflow/"},"frontmatter":{"title":"iOS app distribution workflow overview"}}}},"staticQueryHashes":["2841359383"]}